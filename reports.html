<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width,initial-scale=1" />
    <title>Reports - LogiTrack</title>
    <link rel="stylesheet" href="nav.css" />
    <link rel="stylesheet" href="reports.css" />
</head>

<body class="main">

    <!-- Sidebar (matches other pages) -->
    <div class="sidebar" id="sidebar">
        <div class="sidebar-header">
            <button onclick="togglesidebar()">/|\</button>
            <span class="app-name">LogiTrack</span>
        </div>
        <ul class="menu">
            <li><a href="index.html">Dashboard</a></li>
            <li><a href="Orderpage.html">Orders</a></li>
            <li><a href="FleetPage.html">Fleet</a></li>
            <li><a href="reports.html" class="active">Reports</a></li>
            <li><a href="SettingPage.html">Settings</a></li>
        </ul>
    </div>

    <!-- Main content (keeps same margin-left & animation from nav.css) -->
    <div class="main-content" id="main">
        <header class="page-header">
            <h1>ðŸ“Š Monthly Reports</h1>
            <p class="muted">Download or preview operation reports for any month</p>
        </header>

        <section class="reports-grid" id="reportsGrid">
            <!-- Example static cards â€” these will be replaced if you generate from API -->
            <article class="report-card" data-report-id="2025-06">
                <div class="report-meta">
                    <div class="report-title">June 2025</div>
                    <div class="report-desc">Revenue Â· Deliveries Â· Fleet usage</div>
                </div>
                <div class="report-actions">
                    <button class="btn btn-secondary btn-preview" data-report="2025-06">Preview</button>
                    <button class="btn btn-primary btn-download" data-report="2025-06">Download</button>
                </div>
            </article>

            <article class="report-card" data-report-id="2025-05">
                <div class="report-meta">
                    <div class="report-title">May 2025</div>
                    <div class="report-desc">Delivery insights Â· Operational cost</div>
                </div>
                <div class="report-actions">
                    <button class="btn btn-secondary btn-preview" data-report="2025-05">Preview</button>
                    <button class="btn btn-primary btn-download" data-report="2025-05">Download</button>
                </div>
            </article>

            <article class="report-card" data-report-id="2025-04">
                <div class="report-meta">
                    <div class="report-title">April 2025</div>
                    <div class="report-desc">Performance metrics Â· Routes summary</div>
                </div>
                <div class="report-actions">
                    <button class="btn btn-secondary btn-preview" data-report="2025-04">Preview</button>
                    <button class="btn btn-primary btn-download" data-report="2025-04">Download</button>
                </div>
            </article>
        </section>
    </div>

    <!-- Preview Modal (re-uses modal styles used elsewhere) -->
    <div id="reportPreviewModal" class="modal">
        <div class="modal-content glassy">
            <span class="close" data-close="reportPreviewModal">&times;</span>
            <h2 class="modal-title">Report Preview</h2>
            <div id="reportPreviewBody" class="modal-body">
                <p class="muted">Preview will appear here.</p>
            </div>
        </div>
    </div>

    <script src="index.js"></script>
    <script>
        // Download handler â€” change endpoint to match your backend
        async function downloadReport(reportId) {
            try {
                // Example endpoint (adjust to your API):
                const url = `http://localhost:8000/api/reports/download?report_id=${encodeURIComponent(reportId)}`;

                const res = await fetch(url, { method: 'GET' });
                if (!res.ok) throw new Error('Server error: ' + res.status);

                const blob = await res.blob();
                const a = document.createElement('a');
                const filename = `report-${reportId}.pdf`; // adjust extension as needed
                a.href = URL.createObjectURL(blob);
                a.download = filename;
                document.body.appendChild(a);
                a.click();
                a.remove();
                URL.revokeObjectURL(a.href);
            } catch (err) {
                console.error('Download failed', err);
                alert('Failed to download report. Check server/CORS and the endpoint URL.');
            }
        }

        // Preview handler â€” fetch summary or HTML snippet
        async function previewReport(reportId) {
            try {
                const url = `http://localhost:8000/api/reports/preview?report_id=${encodeURIComponent(reportId)}`;
                const res = await fetch(url);
                if (!res.ok) throw new Error('Server error: ' + res.status);
                const html = await res.text(); // assume server returns HTML snippet or plaintext
                document.getElementById('reportPreviewBody').innerHTML = html || '<p>No preview available.</p>';
                showModal('reportPreviewModal');
            } catch (err) {
                console.error('Preview failed', err);
                document.getElementById('reportPreviewBody').innerHTML = '<p class="error">Failed to load preview.</p>';
                showModal('reportPreviewModal');
            }
        }

        // Attach listeners (works for dynamic content too)
        document.addEventListener('click', (e) => {
            const d = e.target;
            if (d.matches('.btn-download')) {
                const id = d.dataset.report;
                downloadReport(id);
            } else if (d.matches('.btn-preview')) {
                const id = d.dataset.report;
                previewReport(id);
            }
        });

        // Modal helpers (matches the modal code we used on Orders)
        function showModal(id) { document.getElementById(id).style.display = 'block'; }
        function closeModal(id) { document.getElementById(id).style.display = 'none'; }
        document.querySelectorAll('.close').forEach(btn => {
            btn.addEventListener('click', e => closeModal(e.target.dataset.close));
        });
        window.addEventListener('click', e => {
            if (e.target.classList && e.target.classList.contains('modal')) e.target.style.display = 'none';
        });

        // Optional: replace static cards with real data from API
        async function loadReportsFromApi() {
            try {
                const res = await fetch('http://localhost:8000/api/reports/list');
                if (!res.ok) return;
                const reports = await res.json();
                const grid = document.getElementById('reportsGrid');
                grid.innerHTML = reports.map(r => `
          <article class="report-card" data-report-id="${r.id}">
            <div class="report-meta">
              <div class="report-title">${r.title}</div>
              <div class="report-desc">${r.summary || ''}</div>
            </div>
            <div class="report-actions">
              <button class="btn btn-secondary btn-preview" data-report="${r.id}">Preview</button>
              <button class="btn btn-primary btn-download" data-report="${r.id}">Download</button>
            </div>
          </article>
        `).join('');
            } catch (err) {
                console.warn('Could not load reports list', err);
            }
        }

        // Uncomment to load data from server on page load:
        // document.addEventListener('DOMContentLoaded', loadReportsFromApi);
    </script>
</body>

</html>