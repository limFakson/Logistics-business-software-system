<!DOCTYPE html>
<html lang="en">

<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>Orders - LogiTrack</title>
  <link rel="stylesheet" href="nav.css" />
  <link rel="stylesheet" href="OrderPage.css" />
</head>

<body class="main">

  <!-- Sidebar Navigation -->
  <div class="sidebar" id="sidebar">
    <div class="sidebar-header">
      <button onclick="togglesidebar()">/|\</button>
      <span class="app-name">LogiTrack</span>
    </div>
    <ul class="menu">
      <li><a href="index.html">Dashboard</a></li>
      <li><a href="Orderpage.html" class="active">Orders</a></li>
      <li><a href="FleetPage.html">Fleet</a></li>
      <li><a href="reports.html">Reports</a></li>
      <li><a href="SettingPage.html">Settings</a></li>
    </ul>
  </div>

  <!-- Main Content -->
  <div class="main-content">
    <h1 class="page-title">Orders</h1>

    <!-- Filter Controls -->
    <div class="controls">
      <input type="text" id="searchInput" placeholder="Search by Order ID or Customer">
      <select id="statusFilter">
        <option value="all">All Statuses</option>
        <option value="delivered">Delivered</option>
        <option value="shipped">Shipped</option>
        <option value="pending">Pending</option>
      </select>
    </div>

    <!-- Cards Grid -->
    <div class="cards" id="orderCards">
      <!-- Order cards will be loaded here dynamically -->
    </div>

    <!-- Fleet Details Modal -->
    <div id="fleetDetailsModal" class="modal">
      <div class="modal-content glassy">
        <span class="close" data-close="fleetDetailsModal">&times;</span>
        <h2 class="modal-title">Fleet & Order Details</h2>
        <div class="modal-body" id="fleetDetails"></div>
      </div>
    </div>

    <!-- Assign Fleet Modal -->
    <div id="assignFleetModal" class="modal">
      <div class="modal-content">
        <span class="close" data-close="assignFleetModal">&times;</span>
        <h2>Assign Fleet to Order</h2>
        <select id="fleetSelect"></select>
        <button id="assignFleetBtn">Assign Fleet</button>
      </div>
    </div>
  </div>

  <script src="index.js"></script>
  <script>
    async function loadOrders() {
      const container = document.getElementById("orderCards");
      container.innerHTML = "<p>Loading orders...</p>";

      try {
        const res = await fetch("https://logitrack-w83a.onrender.com/api/orders/");
        if (!res.ok) throw new Error(`HTTP error! status: ${res.status}`);

        const orders = await res.json();
        container.innerHTML = "";

        orders.forEach(order => {
          const card = document.createElement("div");
          card.classList.add("order-card");
          card.dataset.status = order.status.toLowerCase();
          card.dataset.orderId = order.order_id;
          card.dataset.fleetId = order.fleet_id || 0;

          card.innerHTML = `
            <h3>#${order.order_name}</h3>
            <p><strong>Customer:</strong> ${order.customer_name}</p>
            <p><strong>Destination:</strong> ${order.destination}</p>
            <span class="badge ${order.status.toLowerCase()}">${order.status}</span>
          `;

          // Click event for modal logic
          card.addEventListener("click", () => {
            if (order.fleet_id && order.fleet_id !== 0) {
              // Fleet assigned → show details
              fetch(`https://logitrack-w83a.onrender.com/api/fleets/`)
                .then(res => res.json())
                .then(fleets => {
                  const fleet = fleets.find(f => f.id === order.fleet_id);
                  document.getElementById("fleetDetails").innerHTML = `
            <p><strong>Fleet Name:</strong> ${fleet.name}</p>
            <p><strong>Driver:</strong> ${fleet.driver_name}</p>
            <p><strong>Status:</strong> ${fleet.status}</p>
            <hr/>
            <p><strong>Order:</strong> ${order.order_name}</p>
            <p><strong>Destination:</strong> ${order.destination}</p>
          `;
                  showModal("fleetDetailsModal");
                });
            } else {
              // No fleet assigned → show assignment dropdown
              fetch(`https://logitrack-w83a.onrender.com/api/fleets/`)
                .then(res => res.json())
                .then(fleets => {
                  const select = document.getElementById("fleetSelect");
                  select.innerHTML = fleets.map(f => `<option value="${f.id}">${f.name} - ${f.driver_name}</option>`).join("");
                  document.getElementById("assignFleetBtn").onclick = () => {
                    const fleetId = select.value;
                    fetch(`https://logitrack-w83a.onrender.com/api/assign_fleet/`, {
                      method: "POST",
                      headers: { "Content-Type": "application/json" },
                      body: JSON.stringify({ order_id: order.order_id, fleet_id: parseInt(fleetId) })
                    })
                      .then(res => res.json())
                      .then(() => {
                        alert("Fleet assigned successfully!");
                        closeModal("assignFleetModal");
                        loadOrders();
                      });
                  };
                  showModal("assignFleetModal");
                });
            }
          });

          container.appendChild(card);

        });

      } catch (err) {
        console.error("Error loading orders:", err);
        container.innerHTML = "<p>Failed to load orders.</p>";
      }
    }

    function showModal(id) {
      document.getElementById(id).style.display = "block";
    }
    function closeModal(id) {
      document.getElementById(id).style.display = "none";
    }
    document.querySelectorAll(".close").forEach(btn => {
      btn.addEventListener("click", e => closeModal(e.target.dataset.close));
    });
    window.onclick = e => {
      if (e.target.classList.contains("modal")) {
        e.target.style.display = "none";
      }
    };

    document.addEventListener("DOMContentLoaded", loadOrders);
  </script>
</body>

</html>